#!/bin/sh
#
# deploy:
# Update installation of services from CVS.
#
# Copyright (c) 2004 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: deploy,v 1.4 2005-02-03 11:47:40 francis Exp $
#

set -e

# Check who and where we are, and include useful functions
SERVICES_BIN=`pwd`
MYSOCIETY_BIN=$SERVICES_BIN/../../bin
EXPECTED_HOST=very.unfortu.net
SCRIPT_COMMAND=services/bin/deploy
. ../../shlib/deployfns

# User to load test schema
PSQL_SCHEMATEST_USER=pgsql

# Which virtual server to update
SERVICES_VHOST=$1
[ x$SERVICES_VHOST = x ] && die "specify target vhost directory as single argument"
[ ! -d $SERVICES_VHOST ] && die "specify target vhost directory as single argument"

# Write To Them
SERVICES_NAME="Services"
SERVICES_UNAME=msservices
SERVICES_DEPLOYSPACE=$SERVICES_VHOST/deployspace
hostname=$( echo $SERVICES_VHOST | sed 's@/$@@' | sed 's@^.*/@@' )
SERVICES_DB_UNIX_USER=msservices

# Main body of script
fmt << END
This will update $hostname from CVS and gracefully restart 
Apache.  It will warn you first if any database schemas need
upgrading, or config files fixing.  These get fixed in the deploy
space, i.e. the place where the "cvs export" happens to, before
copying over to the live server.

Press RETURN to continue.
END
read DUMMY

warn "Exporting from CVS..."
cvs_export $SERVICES_UNAME $SERVICES_VHOST $SERVICES_DEPLOYSPACE

warn "Fixing permissions for mssecure..."
# for suexec to work on these, when shown from mssecure
chown -R mssecure $SERVICES_DEPLOYSPACE/mysociety/services/web-admin
chgrp -R mssecure $SERVICES_DEPLOYSPACE/mysociety/services/web-admin

warn "Checking config files..."
check_config_files $SERVICES_DEPLOYSPACE/mysociety/services/conf

warn "Checking database schemas..."
read_conf $SERVICES_DEPLOYSPACE/mysociety/services/conf/general
check_pgsql_schema $SERVICES_DB_UNIX_USER $SERVICES_DEPLOYSPACE/mysociety/services/Ratty/schema.sql $OPTION_RATTY_DB_NAME $OPTION_RATTY_DB_USER $OPTION_RATTY_DB_PASS
check_pgsql_schema $SERVICES_DB_UNIX_USER $SERVICES_DEPLOYSPACE/mysociety/services/mapit-dadem-loading/mapit-schema.sql $OPTION_MAPIT_DB_NAME $OPTION_MAPIT_DB_USER $OPTION_MAPIT_DB_PASS
check_pgsql_schema $SERVICES_DB_UNIX_USER $SERVICES_DEPLOYSPACE/mysociety/services/mapit-dadem-loading/dadem-schema.sql $OPTION_DADEM_DB_NAME $OPTION_DADEM_DB_USER $OPTION_DADEM_DB_PASS 

warn "Stopping services..."
down_notice $SERVICES_VHOST $SERVICES_NAME

warn "Rsyncing new data files..."
rsync_across $SERVICES_DEPLOYSPACE $SERVICES_VHOST

warn "Starting services..."
apachectl graceful
up_notice $SERVICES_VHOST

