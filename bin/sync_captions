#!/usr/bin/perl -w

use strict;

# Horrible boilerplate to set up appropriate library paths.
use FindBin;
use lib "$FindBin::Bin/../lib";
use lib "$FindBin::Bin/../../perllib";

use Getopt::Long;

use BBCParl::Captions;

# get command line options

my ($help, $from, $to, $date, $verbose, $no_mirror, $no_hansard, $print_stats, $no_output_write, $debug, $no_retries, $no_updates, $yes_updates) = ('','','','','','','','','','','', '');

$help = 0;
$verbose = 1;

$no_mirror = 0;
$no_hansard = 0;
$print_stats = 0;
$no_output_write = 0;

$debug = 0;
$no_retries = 0;
$no_updates = 0;
$yes_updates = 0;

GetOptions (
            'help+' => \$help,
            'from=s' => \$from,
            'to=s' => \$to,
            'date=s' => \$date,
            'verbose+' => \$verbose,
            'no-mirror+' => \$no_mirror,
            'no-hansard+' => \$no_hansard,
            'dry-run+' => \$no_output_write,
            'stats+' => \$print_stats,
            'debug+' => \$debug,
            'no-retries+' => \$no_retries,
            'yes-updates+' => \$yes_updates,
            'no-updates+' => \$no_updates
            );

if ($help) {
    print << "END";
usage: sync_captions [--date=yyyy-mm-dd] [--from=yyyy-mm-dd --to=yyy-mm-dd]
                     [--verbose] [--no-mirror] [--no-hansard] [--stats]
                     [--dry-run] [--debug] [--no-retries] [--no-updates]

1) Creates/updates local mirror of captions logfiles from the BBC for
   specified dates (or previous day if no dates are specified).

2) For a given date or range of dates, extracts captions data from
   local files and Hansard data from TheyWorkForYou.com, and
   synchronises the two lists of speeches.

3) Produces a list of speeches to be updated with new timing data (in
   the form gid,htime) that is then fetched by TheyWorkForYou.com and
   applied to the master database.

--help                   Print this information

--verbose                Print all messages to STDOUT (off by default)

--date=yyyy-mm-dd        Only update speeches on yyyy-mm-dd (default is previous day's date)

--from=yyyy-mm-dd        Only update speeches between yyyy-mm-dd
--to=yyyy-mm-dd          and yyyy-mm-dd

--no-mirror              Do not fetch updated captions files from the BBC (just use local mirror)

--no-hansard             Do not fetch or process any Hansard

--dry-run                Fetch and combine captions and Hansard, but do not write out update files or send updated timestamps to TheyWorkForYou

--no-updates             Do not send any updated timestamps to TheyWorkForYou
--yes-updates            Force send of updated timestamps to TheyWorkForYou

--no-retries             Only try each date once (default is to try 5 times, with an hour between attempts)

--stats                  Print summary of this run to STDOUT

--debug                  Prints out debugging information to STDERR (off by default)

END

    exit 0;
}

# invoke the actual captions-processing code

my $object = BBCParl::Captions->new(
                                    'from' => $from,
                                    'to' => $to,
                                    'date' => $date,
                                    'verbose' => $verbose,
                                    'no-mirror' => $no_mirror,
                                    'no-hansard' => $no_hansard,
                                    'no-output-write' => $no_output_write,
                                    'no-retries' => $no_retries,
                                    'no-updates' => $no_updates,
                                    'yes-updates' => $yes_updates,
                                    'print-stats' => $print_stats,
                                    'debug' => $debug
                                    );

#$object->{'debug'} = 1;

if ($object->run()) {
    exit(0);
} else {
    exit(-1);
}
