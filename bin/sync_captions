#!/usr/bin/perl -w

use strict;

# Horrible boilerplate to set up appropriate library paths.
use FindBin;
use lib "$FindBin::Bin/../lib";
use lib "$FindBin::Bin/../../perllib";

use Getopt::Long;

use BBCParl::Captions;

# get command line options

my ($help, $from, $to, $date, $verbose, $nomirror, $nohansard, $print_stats, $no_output_write, $debug, $no_retries, $no_updates) = ('','','','','','','','','','','');

$help = 0;
$verbose = 1;

$nomirror = 0;
$nohansard = 0;
$print_stats = 0;
$no_output_write = 0;

$debug = 1;
$no_retries = 0;
$no_updates = 0;

GetOptions (
	    'help+' => \$help,
	    'from=s' => \$from,
	    'to=s' => \$to,
	    'date=s' => \$date,
	    'verbose+' => \$verbose,
	    'nomirror+' => \$nomirror,
	    'nohansard+' => \$nohansard,
	    'dry-run+' => \$no_output_write,
	    'stats+' => \$print_stats,
	    'debug+' => \$debug,
	    'no-retries+' => \$no_retries,
	    'no-updates+' => \$no_updates
	    );

if ($help) {
    print << "END";
usage: sync_captions [--date=yyyy-mm-dd] [--from=yyyy-mm-dd --to=yyy-mm-dd]
                     [--verbose] [--nomirror] [--nohansard] [--stats]
		     [--dry-run] [--debug] [--no-retries] [--no-updates]

1) Creates/updates local mirror of captions logfiles from the BBC for
   specified dates (or previous day if no dates are specified).

2) For a given date or range of dates, extracts captions data from
   local files and Hansard data from TheyWorkForYou.com, and
   synchronises the two lists of speeches.

3) Produces a list of speeches to be updated with new timing data (in
   the form gid,htime) that is then fetched by TheyWorkForYou.com and
   applied to the master database.

--help                   Print this information

--verbose                Print all messages to STDOUT (off by default)

--date=yyyy-mm-dd        Only update speeches on yyyy-mm-dd (default is previous day's date)

--from=yyyy-mm-dd        Only update speeches between yyyy-mm-dd
--to=yyyy-mm-dd          and yyyy-mm-dd

--nomirror               Do not fetch updated captions files from the BBC (just use local mirror)

--nohansard              Do not fetch hansard; do not merge hansard and captions; do not write update files

--dry-run                Fetch and combine captions and hansard, but do not write out update files

--stats                  Print summary of this run to STDOUT

--debug                  Prints out debugging information to STDERR (off by default)

--no-retries             Only try each date once (default is to try 5 times, with an hour between attempts)

--no-updates             Do not upload any updated timestamps (if available) to TheyWorkForYou.com database

END

    exit 0;
}

# invoke the actual captions-processing code

my $object = BBCParl::Captions->new(
				    'from' => $from,
				    'to' => $to,
				    'date' => $date,
				    'verbose' => $verbose,
				    'nomirror' => $nomirror,
				    'nohansard' => $nohansard,
				    'no-output-write' => $no_output_write,
				    'print-stats' => $print_stats,
                                    'debug' => $debug,
                                    'no-retries' => $no_retries,
                                    'no-updates' => $no_updates
				    );

#$object->{'debug'} = 1;

if ($object->run()) {
    exit(0);
} else {
    exit(-1);
}
