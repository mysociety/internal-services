#!/bin/sh
#
# deploy-tea-temp:
# Update installation of Gaze service from CVS, just for tea.ukcod.org.uk
#
# Copyright (c) 2004 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: deploy-tea-temp,v 1.1 2005-08-30 14:32:06 config-tea Exp $
#

set -e

# Check who and where we are, and include useful functions
SERVICES_BIN=`pwd`
MYSOCIETY_BIN=$SERVICES_BIN/../../bin
SCRIPT_COMMAND=services/bin/deploy-tea-temp
. ../../shlib/deployfns
check_who_where tea.ukcod.org.uk root

# User to load test schema
PSQL_SCHEMATEST_USER=pgsql

# Load in parameters
if [ "$1" = "services.mysociety.org" ]
then
    SERVICES_VHOST=/data/vhost/services.mysociety.org
elif [ "$1" = "stagingservices.mysociety.org" ]
then
    SERVICES_VHOST=/data/vhost/stagingservices.mysociety.org
else 
    die "specify stagingservices.mysociety.org or services.mysociety.org as parameter"
fi

# Check virtual server directory
[ ! -d $SERVICES_VHOST ] && die "virtual host directory $SERVICES_VHOST not found"

# Services
SERVICES_NAME="Services"
SERVICES_UNAME=msservices
SERVICES_DEPLOYSPACE=$SERVICES_VHOST/deployspace
hostname=$( echo $SERVICES_VHOST | sed 's@/$@@' | sed 's@^.*/@@' )
SERVICES_DB_UNIX_USER=msservices

# Main body of script
fmt << END
This will update just the Gaze bit of $hostname from CVS and gracefully restart
Apache.  It will warn you first if any database schemas need upgrading, or
config files fixing.  These get fixed in the deploy space, i.e. the place where
the "cvs export" happens to, before copying over to the live server.

Press RETURN to continue.
END
read DUMMY

warn "Exporting from CVS..."
cvs_export $SERVICES_UNAME $SERVICES_VHOST $SERVICES_DEPLOYSPACE

warn "Fixing permissions for mssecure..."
# for suexec to work on these, when shown from mssecure
chown -R mssecure $SERVICES_DEPLOYSPACE/mysociety/services/web-admin
chgrp -R mssecure $SERVICES_DEPLOYSPACE/mysociety/services/web-admin

warn "Checking config files..."
check_config_files $SERVICES_DEPLOYSPACE/mysociety/services/conf

warn "Checking database schemas..."
read_conf $SERVICES_DEPLOYSPACE/mysociety/services/conf/general
check_pgsql_schema $SERVICES_DB_UNIX_USER $SERVICES_DEPLOYSPACE/mysociety/services/Gaze/db/schema.sql $OPTION_GAZE_DB_NAME $OPTION_GAZE_DB_USER $OPTION_GAZE_DB_PASS 

warn "Stopping services..."
down_notice $SERVICES_VHOST $SERVICES_NAME

warn "Rsyncing new data files..."
rsync_across $SERVICES_DEPLOYSPACE $SERVICES_VHOST

warn "Starting services..."
apachectl graceful
up_notice $SERVICES_VHOST

