#!/bin/sh
#
# setup-dademcron
# Set up user who will run DaDem cron jobs. These get updated councillor
# data from GovEval, send corrections back to GovEval, and send mails
# to administrators.
#
# Copyright (c) 2006 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#
# $Id: setup-dademcron,v 1.4 2006-12-18 10:50:21 francis Exp $
#

set -e

DADEMHOME=/home/dademcron

if [ $( hostname ) != bitter ] ; then
    print "Please run dademcron on one machine (bitter) only"
    exit
fi

# Checkout or update the files we need to run dademcron scripts
cd $DADEMHOME
if [ -e "mysociety/CVS/Root" ]
then 
    cd mysociety
    cd services && su dademcron "cvs -Q update -dP" && cd ..
    cd perllib && su dademcron "cvs -Q update -dP" && cd ..
    cd phplib && su dademcron "cvs -Q update -dP" && cd ..
    cd shlib && su dademcron "cvs -Q update -dP" && cd ..
    cd fyr && su dademcron "cvs -Q update -dP" && cd ..
else 
    export CVSROOT=cvs.mysociety.org:/usr/local/cvs
    su dademcron "cvs -Q co mysociety/services"
    su dademcron "cvs -Q co mysociety/perllib"
    su dademcron "cvs -Q co mysociety/phplib"
    su dademcron "cvs -Q co mysociety/shlib"
    su dademcron "cvs -Q co mysociety/fyr"
fi

# Checkout or update the representative data module
cd $DADEMHOME
if [ -e "repdata/CVS/Root" ]
then
    cd repdata
    su dademcron "cvs -Q update -dP"
else
    export CVSROOT=cvs.mysociety.org:/usr/local/privatecvs
    su dademcron "cvs -Q co repdata"
fi

# Checkout or update parlparse
cd $DADEMHOME
if [ -e "parlparse/.svn/README.txt" ]
then
    cd parlparse
    su dademcron "svn -q update"
else
    su dademcron "svn -q co https://scm.kforge.net/svn/ukparse/trunk/parlparse"
fi

cd $DADEMHOME

# Copy conifguration files
cat /data/vhost/services.mysociety.org/mysociety/services/conf/general | su dademcron "cat >mysociety/services/conf/general"
cat /data/vhost/www.writetothem.com/mysociety/fyr/conf/general | su dademcron "cat >mysociety/fyr/conf/general"

# Install .forward
su - dademcron "echo \"team@mysociety.org\" >~dademcron/.forward"

# Install crontab
su dademcron crontab repdata/bin/crontab



